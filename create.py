import json
import os
import re
from dotenv import load_dotenv

# .env 파일 로드 (LLM 요약을 위해 필요할 수 있음)
load_dotenv()

TARGET_FILE = "champ.jsonl" # 우리가 최종 저장할 파일
HARD_KEYWORDS = ["하드 카운터", "하드카운터", "극상성", "닷지", "최악의 상대", "매우 불리하다", "극카운터", "극 카운터", "최악의 카운터", "필벤"]

# --- 1. 파일 관리 함수 ---
def load_and_prepare_data(file_path):
    """기존 JSONL 데이터를 리스트로 로드합니다."""
    if not os.path.exists(file_path) or os.path.getsize(file_path) == 0:
        return []
    
    data_list = []
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            try:
                data_list.append(json.loads(line))
            except json.JSONDecodeError:
                print(f"경고: '{file_path}' 파일의 일부 라인이 깨져있습니다. 해당 라인을 건너뜕니다.")
    return data_list

def save_data(file_path, data_list):
    """
    데이터 리스트를 JSONL 형식으로 저장합니다.
    """
    with open(file_path, 'w', encoding='utf-8') as f:
        for i, champ_data in enumerate(data_list):
            f.write(json.dumps(champ_data, ensure_ascii=False) + '\n')

# --- 2. 핵심 파싱 로직 ---
def parse_manual_data(champion_name, raw_aliases_text, raw_counters_text, raw_footnotes_text):
    """
    사용자가 붙여넣기 한 텍스트를 파싱하여 JSON 객체로 만듭니다.
    """
    
    # 0단계: 별칭 파싱
    aliases = [alias.strip() for alias in raw_aliases_text.split(',') if alias.strip()]
    print(f"-> 별칭 파싱 완료: {aliases}")

    # 1단계: 각주 맵 생성
    footnote_map = {}
    footnote_parts = raw_footnotes_text.split('[')
    for part in footnote_parts[1:]:
        match = re.match(r'(\d+)\]\s*([\s\S]*)', part)
        if match:
            number = match.group(1)
            text = match.group(2).strip()
            text = text.split('[')[0].strip()
            footnote_map[number] = text

    print(f"-> 각주 맵 생성 완료 (총 {len(footnote_map)}개)")

    # 2단계: 카운터 텍스트 파싱
    hard_counters = []
    general_counters = []
    
    # ⭐️ 수정된 부분: 쉼표(,), 공백( ), 글머리 기호(•, ■, -), 줄바꿈(\n)을 모두 분리 기준으로 사용
    # 이렇게 하면 쉼표로 연결된 긴 리스트도 정확하게 분리됨.
    counter_items = re.split(r'\s*,\s*|\s*(?:•|■|-|\n)\s*', raw_counters_text)
    
    for item in counter_items:
        if not item:
            continue
        
        # 챔피언 이름과 각주 번호 분리 (예: "이렐리아[30]")
        match = re.match(r'([^\[]+)(?:\[(\d+)\])?', item.strip())
        
        if match:
            name = match.group(1).strip()
            number = match.group(2)
            
            # 이름이 빈 문자열인 경우 건너뜀
            if not name:
                continue
            
            if number and number in footnote_map:
                # 각주 번호가 있고, 맵에도 존재
                description = footnote_map[number]
                
                # 키워드 검사
                if any(keyword in description for keyword in HARD_KEYWORDS):
                    # ⭐️ 하드 카운터
                    # reason = summarize_reason_llm(description, name) # LLM 요약 (현재 더미)
                    reason = description # ⭐️ 그냥 원본 텍스트를 넣고 싶으면 이걸로
                    hard_counters.append({"name": name, "reason": reason})
                else:
                    # ⭐️ 일반 카운터 (각주O, 키워드X)
                    general_counters.append(name)
            else:
                # ⭐️ 일반 카운터 (각주X)
                general_counters.append(name)

    print(f"-> 파싱 완료: 하드카운터({len(hard_counters)}), 일반({len(general_counters)})")

    # 3단계: 최종 JSON 객체 반환
    return {
        "champion": champion_name,
        "aliases": aliases,
        "hard_counters": hard_counters,
        "general_counters": general_counters
    }

# --- 3. 메인 실행 함수 ---
def main():
    
    # ⭐️⭐️⭐️⭐️⭐️
    # 1. 여기에 챔피언 이름 입력
    CHAMPION_NAME = "암베사"
    
    # 2. 여기에 챔피언 별칭 입력 (쉼표로 구분)
    RAW_ALIASES_TEXT = ""

    # 3. 여기에 '상대하기 힘든 챔피언' 섹션 텍스트 복사
    RAW_COUNTERS_TEXT = """ 
뽀삐[10], 나서스[11], 마오카이[16], 레넥톤[18], 볼리베어[19], 워윅[20], 이렐리아[21], 올라프[22], 일라오이[23], 오공[24], 잭스[26], 세트[27], 판테온[28][29], 트런들, 쉔, 초가스, 칼리스타, 
    """
    
    # 4. 여기에 '각주' 섹션 텍스트 복사
    RAW_FOOTNOTES_TEXT = """


[10] 극상성. 이동기 기반 챔프의 카운터 하면 절대 빼놓고 얘기할 수가 없는 천적. 그야말로 숨도 못 쉬는 라인전을 경험할 수 있다. 패시브 평타 짤짤이와 Q에 달린 퍼뎀 때문에 탱커치고 높은 딜량을 가졌으면서 W만 켜면 패시브는 아예 사용조차 할 수 없고 어쩌다 실수로 벽꿍을 당하거나 고정되기라도 하면 Q 2타까지 고스란히 맞아 압도적인 딜교환 손해를 보며, 타겟팅 CC기에 에어본 궁극기까지 보유해서 라인전이든 소규모 교전이든 한타든 암베사를 완벽하게 마크할 수 있다. 모든 지표가 암베사를 압도하는 극카운터이며, 탑뿐만 아니라 정글과 서폿도 가능한 멀티 포지션 챔피언이기 때문에 맞라인전이 아니더라도 게임 내내 암베사를 견제한다.
[11] 칼리스타와 유사하게 쇠약을 걸면 돌진 속도가 느려지며, 기력 관리를 책임지는 패시브 평타의 발동 또한 방해받는다. 더군다나 암베사의 부실한 라인전 능력으론 나서스를 말려놓는 것도 불가능하며 시간도 나서스의 편이기에 볼리베어 못지않은 극상성이다.
[12] 라인전에서 말자하가 미니언 파밍만 하면서 딜교를 거부하면 암베사가 할 게 없어지며, 암베사의 궁극기는 말자하의 패시브 주문 보호막에 막히는 데다 말자하의 궁극기 제압은 암베사가 자랑하는 기동력을 즉시 문답무용으로 봉인한다. 제압을 의식해 수은을 올리면 그 자체로 손해인 데다 라일라이를 올리는 말자하 특성상 재앙의 환상 지속시간 동안의 슬로우와 후속타로 들어오는 침묵이 암베사를 뚜벅이로 만들어버린다. 여기에 도트딜 동안 모렐로 치감이 오랫동안 지속되기 때문에 피흡을 통한 유지력이 강점인 암베사에게 치명적이다. 한타에서의 포지셔닝 역시 최후방에서 원딜 옆에 지키고 있기 때문에 궁극기를 통해 암살을 시도해야 하는 암베사를 카운터치기 좋다.
[13] 암베사는 스킬을 한 번 사용할 때마다 패시브를 통한 이동을 사용할 수 있고, 이를 통해서 기동력을 챙기고 추가딜을 넣는 챔피언인데 벡스의 우울 표식은 암베사가 패시브 이동을 할 때마다 적용된다. 이로 인해 벡스의 폭발적인 패시브 딜을 견디면서 싸우거나 패시브를 쓰지 않거나 죽음의 이지선다를 강요받게 된다. 가는 라인이 다르다 쳐도 한타 가서 만나면 즉발 공포 맞고 고통만 받는다.
[14] 타겟팅 CC기인 변이를 걸어버리면 이동에 제약을 걸 뿐 아니라 일반 공격도 못하게 되어 힘들어진다.
[15] 난입을 주로 들기 때문에 라인전에선 암베사가 파고 들어도 전이+룬감옥을 통한 타게팅 속박 이후 난입을 발동시켜 유유히 빠져나가면,스킬쿨이 긴 암베사는 이후 라이즈에게 주도권을 내주게 된다.6렙 이후엔 궁극기로 진입을 해도 한 방에 녹이지 못하면 맞궁을 써서 멀리 도망쳐버린다.
[16] 암베사의 탱커 대응 능력은 뛰어난 편이지만 스킬 위주의 딜교환이 마법 흡수의 쿨타임을 지속적으로 줄여주기에 마오카이를 뚫어내기 힘들다. 뒤틀린 전진(w)은 타겟팅 속박이라 암베사가 무슨 수를 써도 피할 수 없으며 후반 기여도 역시 이니시와 접근을 떨쳐내기 좋은 마오카이가 웃는 상성이다.
[17] 접근을 하려 해도 냉기 폭발(q)과 결정화(w) 때문에 접근 자체가 불가능하다. 출시 초기에는 패시브로 벽을 넘을 수 있었기에 쉬웠으나 버그 수정 이후에는 힘들어진 상성.
[18] 암베사의 대표적인 하드 카운터. 카이팅을 하며 싸워야 하는 암베사이지만 딜교를 시도하면 레넥톤은 확정 CC기인 무자비한 포식자(W)를 이용해 암베사의 발을 묶어놓고 일방적으로 때린 뒤 빠지거나, 피가 빠진 암베사를 자르고 토막내기로 끝까지 추격할 수 있다. 착취 카이팅 갉아먹기로 라인전을 버티려고 해도 레넥톤은 라인 유지력이 탑 챔피언 중에서도 최상급이기 때문에 궁을 찍기 전까지 유지력 수단이 없는 암베사가 천천히 말라간다. 무엇보다 가장 큰 문제는, 강화된 무자비한 포식자로 배척의 보호막을 제거한다는 것. 실드로 탱킹을 하는 암베사는 탱킹 수단 하나가 없는 셈이라 분노W+궁 콤보에 다이브 방어도 안된다. 암베사의 R은 맞딜이 아닌 접근용 스킬이라 궁극기의 파워도 레넥톤이 훨씬 강하기에 초중반 내내 주도권을 내줘야만 한다. 후반 포텐셜은 암베사가 높긴 하지만 레넥톤을 상대로 암베사가 포텐셜이 나오는 타이밍까지 무난하게 성장하기는 매우 어려우며 레넥톤도 거듭된 상향으로 과거만큼 후반에 힘이 꺾이지 않아 라인전부터 교전까지 레넥톤에게 휘둘리며, 설령 레넥톤이 망했어도 한타에서도 원딜한테 진입한 암베사를 레넥톤이 확정스턴과 보호막 제거로 마킹할 수 있기 때문에 암베사의 포텐셜과 별개로 게임 내내 휘둘린다. 그만큼 극상성이다 보니 대회에서도 암베사를 할 때는 레넥톤을 밴하는 경우가 많다.
[19] 하드 CC기를 보유하고 있으며 라인전부터 맞딜로 찍어눌리는 극상성이다. 초반이 약한 암베사로는 볼베에게 큰 피해를 주기도, 딜을 감당하기도 어려우며 암베사의 패시브는 스킬마다 딜레이가 있고 한번에 크게 이동하는 스킬이 아니기에 거리조절을 실수한다면 바로 잡혀서 타겟팅 하드 CC기와 스킬 연계에 머리가 터져버린다. 사리면서 파밍하자니 쿨타임이 긴 Q2를 제외하고 사거리가 긴 스킬이 없어 그것도 불가능하다. 잘 버텨서 후반을 가도 잘 성장한 볼리베어는 암베사에게 사이드를 밀리지 않으며 15시즌 채용률이 높은 사이드 템트리라면 오히려 사이드에서도 압도당한다. 그나마 사이드 템트리의 볼리베어의 경우 한타에선 꽤 힘이 빠지는 편이라서 사이드보다는 팀파이트 위주로 게임을 풀어나가는 것이 좋다.
[20] 워윅은 탑 라인에서 초반 1대1이 가장 강한 챔피언 중 하나이며, 워윅을 상대로는 제대로 성장하는 것이 불가능한 데다 동성장이더라도 게임 내내 워윅과의 1:1을 이길 확률은 희박하다. 워윅은 패시브의 평타 회복이 핵심인 챔피언이라 평타를 못 치게 CC기를 넣거나 원거리에서 일방적으로 화력을 투사하는 게 대처법이지만, 암베사는 근접 챔피언인 데다 가진 군중제어기는 궁극기 하나뿐이다. 궁극기를 쓸 때도 워윅이 맞궁이나 빠른 이속으로 피할 수도 있고, E를 미리 켜두어 버틸 수도 있으며 워윅은 체력 25% 미만에서 아주 강해지기 때문에 맞딜로 눌릴 수도 있다. 또한 암베사의 패시브는 총 거리 자체는 길지만 이동이 빠른 스킬이 아니기에 워윅의 패시브 이속을 떨쳐내기 어려우며, 패시브 이속이 아니더라도 Q로 달라붙어 따라올 수 있기에 기동성 차이로 우세를 점하기도 어렵다.
[21] 이렐리아의 스킬은 피하기 쉽지만 그뿐, 이렐리아 입장에서도 암베사의 스킬은 발동이 빠르지 않기 때문에 칼날 쇄도(Q)로 피하기 어렵지 않으며, 암베사는 맞딜은 약한 편이고 스킬 쿨타임이 길기 때문에 때릴 것만 때리고 도망치는 이기적인 딜교만 해야 하는데 이렐리아는 칼날 쇄도(Q)로 미니언을 타며 도망치는 암베사를 끝까지 추격할 수 있어 싸움을 강제하기 쉽고, 서로 맞딜하는 구도가 되면 암베사가 스킬을 다 맞히고 이렐리아의 스킬은 다 피해도 4스택 이렐리아의 평타만 맞고 딜교환을 지는 상황이 나온다.
[22] 올라프도 탑에서 1대1이 아주 강력한 챔피언이다. 볼리베어와 같이 압도적인 맞딜 격차로 인해 cs만 먹기도 어려우며, 패시브로 멀리서 날리는 도끼를 피할 수는 있지만 바로 앞에서 쏘는 도끼는 피하기 어렵다. 사이드에서도 올라프에게 멀리서 견제정도는 할 수 있겠지만 선푸쉬는 사실상 불가능하며, 1대1 구도에서는 눕는다 쳐도 올라프가 선푸쉬 후 아군 정글로 들어가기 시작하면 게임이 아주 힘들어진다.
[23] 높은 기동성으로 촉수와 영혼 끌기를 잘 피할 수는 있지만, 하드 CC기가 없어 일라오이를 붙잡을 수 없으며, 설상가상으로 영혼 끌기를 한 번이라도 맞게 되면 그동안 치고 빠지기로 이득본 거 다 까먹히고 딜교가 아예 성립이 안하므로 도망밖에 답이 없다.
[24] 암베사는 초반 쿨타임이 매우 길어 맞딜이 약한데 오공은 1렙부터 맞딜이 강하므로 절대 E 거리를 주면 안 된다. 1레벨을 넘겨도 상황은 마찬가지인데 오공의 Q는 사거리가 길어서 암베사가 패시브로 거리조절 하려 해도 Q를 먼저 맞게 되고, 딜교환 도중에도 오공은 분신으로 스킬 하나를 흘려낼 수 있다. 궁극기를 찍어도 Q를 3번 쓰고 광휘를 4~5번씩 돌리며 에어본이 두 번 들어오는 오공의 궁극기로 인해 맞딜 격차는 여전히 압도적이며, 에어본에 암베사의 패시브가 끊기기라도 하면 그대로 킬을 주게 된다. 한타는 대부분의 경우 광역 에어본을 두 번 넣는 오공이 더 좋으며 사이드에서도 한번 거리를 주면 오공의 E,W,R로 인한 기동력과 R의 연속 에어본으로 인해 거리를 벌리기 어려우며, 맞딜은 대인전에서의 궁극기 성능 격차가 너무 심해 절대 못 이긴다.
[25] 맞딜하면 무조건 지고, 둔화 걸고 도망가도 궁극기의 이속 + 둔화 무시와 Q스킬로 도륙내러 쫓아온다. 하드 CC기도 궁극기밖에 없고, 이마저도 암베사가 적을 향해 돌진하게 되기 때문에 마스터 이를 상대로는 사용할 수 없다.
[26] 스킬 쿨타임이 길어 잭스와의 맞딜이 성립하지 않고, cc기가 부족해 한타에서 아군 딜러를 물러 들어오는 잭스를 마킹하기 힘들다. 반격에 달린 광역 스킬 대미지 25% 감소도 은근히 성가시다. 중후반 암베사의 대인전 능력은 매우 강력하지만, 그것 역시 후반 브루저 계열에 있어 대인전의 패왕인 잭스를 뚫어낼 정도는 되지 못하기에 좋지 못한 상대.
[27] 근접해서 싸우는 암베사 스킬 특성상 세트의 풀차징 EW를 맞기 매우 쉬워 딜교 자체가 성립이 안 된다. 거기다 궁으로 뒷라인을 물어도 세트의 대미장식을 맞고 홀로 적진에서 폭사하는 경우도 많이 나온다. 대신 세트는 기동성이 저열해 암베사를 추격하기 힘드며 안면강타와 강펀치 모두 쿨이 꽤 길기 때문에 착취를 들고 치고 빠지면서 갉아먹기 식으로 라인전을 풀어가면 할만하다.
[28] 초반 스킬 쿨이 길어 스킬을 적재 적소에 쓴다고 해도 남는 게 평타 밖에 없는 암베사에 비해 판테온은 주력기인 혜성의 창이 1렙 기준으로도 4.4초로 굉장히 짧은 편이고, 스킬과 패시브 대쉬를 통한 카이팅 플레이도 판테온의 방호의 도약(W)에 강제로 끊긴다. 스킬 가속이 쌓이기 전의 암베사는 라인전 중 짧은 딜교 후 뒤로 빠지는 플레이를 하는데, 이 방식을 판테온이 방호의 도약, 방패 돌격으로 카운터 칠 수 있다. 암베사가 강해지는 타이밍보다 판테온이 강해지는 타이밍이 훨씬 빠르며, 극후반에 간다면야 성장력이 좋고 판테온 궁극기 패시브의 상위호환 패시브를 지닌 암베사가 대인전 자체는 더 강해지겠지만 어차피 한타에서는 들어오는 암베사에게 기절만 걸어줘도 암베사가 위험해진다. 게다가 암베사의 2연속 너프 이후로는 판테온이 독사의 송곳니를 채용할 경우 사이드 1대1에서도 이긴다고 확실히 장담할 수 없게 되어서 조심해야 하는 상대이다. 판테온은 물리 관통력, 높은 공격력을 잘 써먹는 챔피언이라 독사의 송곳니를 올려도 약한 타이밍이 그닥 나오지 않는다는 것도 불편한 요소.
[29] 참고로 암베사의 궁극기가 판테온에게 적중하였을 때, 판테온이 궁극기에게 적중 당하기 직전 뒤를 보고 방패 돌격을 사용할 경우 궁극기 대미지가 전부 막히는 현상이 있다. 버그가 아니라 암베사의 궁극기가 순간이동 판정이라 뒤로 돌아오는 암베사를 예측해 방패 돌격을 먼저 사용하면 결국 암베사를 보고 방패를 드는 판정이 되어 막히게 되는 것. 암베사 궁극기에 딜레이도 있기 때문에 판테온 유저가 암베사를 주의 깊게 대처하는 경우 은근히 자주 나오는 상황이다.
[30] 암베사의 선조격인 패시브를 가졌는데 이쪽은 원거리 딜러인 데다 평타로 발동시키기 때문에 기동력에서 따라잡기 힘들다. 물론 둔화에 매우 취약한 칼리스타 특성상 궁극기 히트에 성공한다면 E로 99% 슬로우를 묻힌뒤 폭딜로 찢어버릴 수 있지만, 칼리스타 역시 궁극기 운명의 부름을 통해 에어본과 서폿의 후속 CC기로 대처하면 오히려 2:1로 싸먹히는 구도가 만들어져 역관광을 당하기 쉽다.
[31] 느려터진 논타겟 위주의 스킬 구성임에도 불구하고 상대하기가 쉽지 않다. 초가스의 주력딜인 Q가 논타겟이라 피하는 것은 굉장히 쉽지만 W는 범위가 넓고 길어 피하기가 쉽지 않고 침묵이 달려있어 잘못 파고 들었다간 침묵 이후 연계되는 파열과 E의 깡딜 때문에 손해를 보기 쉽다.또한 초가스의 스킬을 모두 피해 딜교에서 이득을 봐도,암베사는 초반 스킬쿨이 길기 때문에 한동안 몸을 사려야 하는데,그동안 패시브의 뛰어난 유지력으로 금방 체력을 복구하고 설상가상 E의 뛰어난 푸쉬력 때문에 라인이 밀리게 되어 주도권을 내주기 쉬우며 궁극기의 무시무시한 깡딜 탓에 피흡과 실드를 믿고 핑퐁을 하기에도 까다롭다.물론 후반을 간다면 1대1은 암베사가 당연히 이기겠지만 초가스 역시 성장 기대치가 높은 편이며 굳이 암베사와 1대1을 하고 있을 이유가 없으므로 급할 것이 없다.
[32] 자야는 모든 종류의 돌진형 챔프의 카운터로 암베사 역시 자야의 깃부르미 속박에 노출되기 쉬우며, 궁극기 공개처형은 아주 짧은 시간동안만 제압과 기절효과를 주기 때문에 기절 효과를 정화로 풀거나 아예 저항의 비상으로 씹고 깃부르미로 맞받아칠 수 있다.
[33] 최대 체력 피해의 Q스킬, 방어력 관통력과 스킬 피흡을 가진 암베사에게는 체력탱인 사이온은 그저 피흡 먹잇감이며, 무엇보다 압도적인 기동성으로 사이온의 QE를 피하고 죽어서 달려오는 사이온을 회피하기 쉽다.



"""
    # ⭐️⭐️⭐️⭐️⭐️
    
    print(f"--- 수동 파서 시작: {CHAMPION_NAME} ---")
    
    # 5. 파싱 실행
    new_champion_data = parse_manual_data(CHAMPION_NAME, RAW_ALIASES_TEXT, RAW_COUNTERS_TEXT, RAW_FOOTNOTES_TEXT)

    # 6. 기존 데이터 로드
    all_data_list = load_and_prepare_data(TARGET_FILE)

    # 7. 데이터 업데이트 또는 추가
    updated = False
    for i, data in enumerate(all_data_list):
        if data.get('champion') == new_champion_data['champion']:
            all_data_list[i] = new_champion_data # 기존 데이터 덮어쓰기
            updated = True 
            print(f"'{new_champion_data['champion']}'의 데이터를 업데이트했습니다.")
            break
            
    if not updated:
        all_data_list.append(new_champion_data) # 새 데이터 추가
        print(f"'{new_champion_data['champion']}'의 데이터를 새로 추가했습니다.")

    # 8. 파일 저장
    save_data(TARGET_FILE, all_data_list)
    print(f"성공: 데이터가 '{TARGET_FILE}' 파일에 저장되었습니다.")
if __name__ == '__main__':
    main()