import json
import os
import re
from dotenv import load_dotenv

# .env 파일 로드 (LLM 요약을 위해 필요할 수 있음)
load_dotenv()

TARGET_FILE = "champ.jsonl" # 우리가 최종 저장할 파일
HARD_KEYWORDS = ["하드 카운터", "하드카운터", "극상성", "닷지", "최악의 상대", "매우 불리하다", "극카운터", "극 카운터"]

# --- 1. 파일 관리 함수 ---
def load_and_prepare_data(file_path):
    """기존 JSONL 데이터를 리스트로 로드합니다."""
    if not os.path.exists(file_path) or os.path.getsize(file_path) == 0:
        return []
    
    data_list = []
    with open(file_path, 'r', encoding='utf-8') as f:
        for line in f:
            try:
                data_list.append(json.loads(line))
            except json.JSONDecodeError:
                print(f"경고: '{file_path}' 파일의 일부 라인이 깨져있습니다. 해당 라인을 건너뜕니다.")
    return data_list

def save_data(file_path, data_list):
    """
    데이터 리스트를 JSONL 형식으로 저장합니다.
    """
    with open(file_path, 'w', encoding='utf-8') as f:
        for i, champ_data in enumerate(data_list):
            f.write(json.dumps(champ_data, ensure_ascii=False) + '\n')

# --- 2. 핵심 파싱 로직 ---
def parse_manual_data(champion_name, raw_counters_text, raw_footnotes_text):
    """
    사용자가 붙여넣기 한 텍스트를 파싱하여 JSON 객체로 만듭니다.
    """
    
    # 1단계: 각주 맵 생성
    footnote_map = {}
    footnote_parts = raw_footnotes_text.split('[')
    for part in footnote_parts[1:]:
        match = re.match(r'(\d+)\]\s*([\s\S]*)', part)
        if match:
            number = match.group(1)
            text = match.group(2).strip()
            text = text.split('[')[0].strip()
            footnote_map[number] = text

    print(f"-> 각주 맵 생성 완료 (총 {len(footnote_map)}개)")

    # 2단계: 카운터 텍스트 파싱
    hard_counters = []
    general_counters = []
    
    # ⭐️ 수정된 부분: 쉼표(,), 공백( ), 글머리 기호(•, ■, -), 줄바꿈(\n)을 모두 분리 기준으로 사용
    # 이렇게 하면 쉼표로 연결된 긴 리스트도 정확하게 분리됨.
    counter_items = re.split(r'\s*,\s*|\s*(?:•|■|-|\n)\s*', raw_counters_text)
    
    for item in counter_items:
        if not item:
            continue
        
        # 챔피언 이름과 각주 번호 분리 (예: "이렐리아[30]")
        match = re.match(r'([^\[]+)(?:\[(\d+)\])?', item.strip())
        
        if match:
            name = match.group(1).strip()
            number = match.group(2)
            
            # 이름이 빈 문자열인 경우 건너뜀
            if not name:
                continue
            
            if number and number in footnote_map:
                # 각주 번호가 있고, 맵에도 존재
                description = footnote_map[number]
                
                # 키워드 검사
                if any(keyword in description for keyword in HARD_KEYWORDS):
                    # ⭐️ 하드 카운터
                    # reason = summarize_reason_llm(description, name) # LLM 요약 (현재 더미)
                    reason = description # ⭐️ 그냥 원본 텍스트를 넣고 싶으면 이걸로
                    hard_counters.append({"name": name, "reason": reason})
                else:
                    # ⭐️ 일반 카운터 (각주O, 키워드X)
                    general_counters.append(name)
            else:
                # ⭐️ 일반 카운터 (각주X)
                general_counters.append(name)

    print(f"-> 파싱 완료: 하드카운터({len(hard_counters)}), 일반({len(general_counters)})")

    # 3단계: 최종 JSON 객체 반환
    return {
        "champion": champion_name,
        "hard_counters": hard_counters,
        "general_counters": general_counters
    }

# --- 3. 메인 실행 함수 ---
def main():
    
    # ⭐️⭐️⭐️⭐️⭐️
    # 1. 여기에 챔피언 이름 입력
    CHAMPION_NAME = "하이머딩거"
    
    # 2. 여기에 '상대하기 힘든 챔피언' 섹션 텍스트 복사 (새로운 쉼표 구분 형식)
    RAW_COUNTERS_TEXT = """ 
      제라스, 직스,  바루스, 빅토르, 카서스, 흐웨이, 트위스티드 페이트[23], 신드라, 아칼리, 제드, 탈론, 야스오, 럼블[22], 요릭[25][26], 사이온
    """
    
    # 3. 여기에 '각주' 섹션 텍스트 복사 (긴 각주 목록)
    RAW_FOOTNOTES_TEXT = """\
    


[17] 하이머딩거와 마찬가지로 소환수를 소환하여 딜을 하는 챔피언인데 문제는 아지르의 소환수인 모래 병사들은 타겟팅 지정 불가 + 무적이다. 게다가미드 메이지 챔피언 중에서 사거리까지 긴 편이라서 하이머딩거의 견제에 고통받을 일도 없다. 즉 똑같이 소환수를 소환하면 아지르는 하이머딩거의 사거리 밖에서 편안하게 모래 병사로 하이머딩거의 포탑들을 다 치울 수 있는 반면 하이머딩거는 아지르의 모래 병사를 처리할 방법이 전무하다. 때문에 극초반 푸시력부터 상대가 안 되며 템이 나오면 나올수록 모래 병사의 딜이 더 강해지기 때문에 포탑이 치워지는 속도 역시 더 빨라진다. 그나마 아지르의 마나 소모량이 커서 함부로 스킬들을 남발하지는 못하는 점이 있기는 하지만 이마저도 사실 아지르가 쓸데없이 스킬을 하이머딩거에게 꽂아넣지 않고 모래 병사로 하이머딩거의 포탑 치우기에만 집중하면 딱히 마나 소모량으로 고통받지도 않는다. 성장성도 아지르가 월등하게 높기 때문에 굉장히 골치 아픈 존재.
[18] 간단하다. 누누의 잡아먹기 때문에 딩거가 포탑 농성 및 궁극기 강화로 발악을 하는 것이 전혀 통하지 않는다. 누누는 99% 정글러로 기용되는데 만약 딩거 상대팀 정글이 누누라면 딩거는 특유의 라인을 미는 플레이조차 고민될 지경. 거기에 딩거는 이동기 없는 뚜벅이에 물몸이라서 누누에게 한 번 물리면 6레벨 이후부터는 궁극기는 물론 초시계나 점멸을 총동원해도 누누의 눈덩이 돌진 이후 궁극기 콤보에 절대 살아남지 못한다.
[19] 증강한 죽음의 광선(E)를 이용하여 하이머딩거의 포탑을 한번에 2개씩 철거 해버리는 기적의 상성이다. 심지어 q를 제외한 나머지 W와 궁극기도 포탑철거하는데 최적화 되어 있다. 그래도 증강 이전까지는 할 만하기 때문에 아지르보다는 낫다.
[20] 2020년 이후로는 라인 카서스는 사실상 사장된 전략이라서 라인에서 볼 일은 이제는 없지만, 만약 만난다면 카서스가 미니언 뒤에서 얌전히 Q로 파밍만 해도 저절로 딩거가 불리해진다. 게다가 카서스의 주 라인인 정글러로 마주쳐도 문제인게, 카서스는 딩거의 사정거리 밖에서 싸우는 것이 보통이기 때문에 딩거가 포탑 궁극기 강화 발악으로 역관광을 노릴 각을 도무지 주지 않는다.
[21] 11시즌 기준 탑 쉬바나는 사장된 지 오래지만 그래도 만난다면 쉽지 않은 상대. 초반에는 여느 근접 챔피언을 상대하는 것처럼 하딩 쪽에서 압박이 가능하지만 쉬바나가 준수한 원거리 파밍기인 화염 숨결(E)로 챙길 것만 챙기는 식으로 대응하며 반반 성장을 유도한다면 성장성이 우수한 쉬바나 입장에서는 전혀 손해볼 것이 없다. 특히 궁극기를 찍은 이후가 큰 문제인데, 쉬바나가 용 형상인 상태에서 쉴새없이 날려대는 포킹이 문제. 웬만한 AP 누커 급의 대미지를 뽐내는 브레스에 맞는다면 포탑은 자동 철거되며 하딩 본체가 맞는다면 정말 엄청난 체력 손실을 볼 수 있다. 갱플랭크와 마찬가지로 초반 압박은 쉬운 편이나, 첫 귀환 이후 궁극기를 찍는 시점부터 점점 불리해지는 상성이라고 할 수 있다.
[22] 초반에는 푸쉬가 가능하지만 작살로 포탑을 치우면서 화방으로 라인을 밀기 시작하는 시점부터 답이 없다. 심지어 마나도 안 쓰는 노코스트 챔피언인데다 상황에 따라 역으로 하이머딩거를 포탑에 박아놓고 짤짤이를 하는 장면도 나온다.
[23] 포탑에도 사기 주사위의 골드 보너스가 들어가서 9골드씩 주게 된다. 트페 특유의 라인밀고 궁극기 운영에도 대처할 수단이 없다는 것도 문제점. 그냥 포탑을 안 깔고 로켓과 수류탄으로 싸우는 게 더 나을 정도다.
[24] 사거리가 긴 편은 아니지만 전천후로 극악무도 중첩이 충분히 쌓인 베이가는 포탑을 일격으로 부숴버린다. 본체가 사건의 지평선에 갇히면 얄짤없이 점멸이나 궁포탑을 빼야 한다. 포탑을 역이용하는 챔피언에도 해당되어서 사악한 일격(Q)로 포탑을 처치하면 패시브 스택이 쌓인다.
[25] 똑같이 소환수를 통해 싸우는 챔피언으로 둘 다 소환수의 운용법도 비슷하다. 각자의 E스킬인 전자폭풍 수류탄과 애도의 안개를 맞히면 소환수들이 해당 스킬에 맞은 적에게 어그로가 끌리면서 공격하는 방식인데 문제는 딩거의 소환수는 사거리가 있는데 요릭은 없다는 것. 따라서 요릭은 딩거의 E를 맞기 전 빽무빙을 치고 있었다면 레이저를 잘 안맞지만 요릭의 E는 맞는 순간 구울 풀힛이다. 6렙 전에는 딩거가 주도권을 가지지만 6렙 이후부터는 점점 답이 없어지며 딩거의 로봇보다 요릭의 안개마녀와 구울들의 푸시력이 훨씬 더 빨라서 딩거만 일방적으로 라인을 밀지도 못하는데다가 무덤이 어느 정도 쌓인 시점에 애도의 안개를 한 번이라도 맞으면 순식간에 체력이 반피가 날아가는 등 한 방에 주도권을 내주게 되기 때문에 매우 까다로운 상대로 변모한다. 게다가 딩거의 로봇은 요릭이 평타 - 최후의 의식(Q)으로 한 방에 제거함과 동시에 체력 회복까지 가능하지만 요릭의 안개마녀와 구울들은 광역 스킬에 50% 내성이기 때문에 로봇이 아무리 때려봤자 구울들을 제거하는 데에 한 세월이 걸리며 오로지 딩거 자체의 평타로만 제거해야 하는 등 서로의 소환수를 제거하는 방식도 요릭이 훨씬 유리하다. 게다가 딩거는 뚜벅이라 요릭의 망자의 진(W)에 매우 취약하고 점멸없이는 빠져나갈 방법이 없는 것은 덤.
[26] 궁극기 레벨 상관없이 마녀 앞을 가로막고 있는 미니언이 없다는 전제 하에 업그레이드(R) - 초소형 로켓(W)으로 안개마녀에게 풀히트를 성공했다면 안개마녀가 한 방에 즉사하기는 한다. 그러나 업그레이드(R) - 초소형 로켓(W)의 풀히트는 상당히 어렵고 마녀 앞에 미니언이 하나라도 가로막고 있다면 불가능하다.
[27] 극초반에는 당연히 딩거에게 주도권이 있어 일방적으로 견제할 수 있지만, 포탑 때문에 자연스럽게 라인이 밀리면 나서스가 가장 좋아하는 포탑 끼고 드러누워 CS 받아먹기 구도가 될 수 있다. 라인이 밀려 있어 갱도 부르기 어렵고 딩거 혼자 다이브를 할 수도 없으니 자연스럽게 나서스의 성장을 막을 수 없게 되며, 이 상태로 방치하면 머지않아 딩거의 포탑까지 나서스의 한 끼 스택으로 전락하는 최악의 상황이 된다. 견제를 해도 패시브 덕에 미니언을 치면서 체력을 계속 회복하는 것은 덤. E선마 나서스라면 아예 시작부터 포탑이 장판에 타들어가며 주도권을 내주게 되며, 몸이 약한 딩거는 나서스가 도란링+콩콩이+주문 작열을 간다면 금세 체력이 바닥난다.
[28] 의지의 힘(W)을 사용해서 역으로 하이머딩거의 포탑을 무기로 사용한다. 궁포탑도 저 멀리로 던져버리면 그만이다.
[29] 버티는 데에 능한 탱커인데다가 학살자의 포효(E)로 하이머딩거의 궁 포탑을 포함한 모든 포탑을 밀쳐내 장악 능력을 약화시킬 수 있다.
[30] 6레벨 이전까지는 하이머딩거가 견제를 통해 우위를 점할 수 있지만 6레벨이 되어 아칼리가 궁극기를 배우고 나면 하이머딩거는 순식간에 처형당하는 신세로 전락한다. 황혼의 장막(W)을 깔 경우 오토 타겟팅인 하이머딩거의 포탑 또한 무용지물이 되어버리는 건 덤.
[31] 이는 이렐리아는 챔프와 유저층 특성상 사이드를 자주 가는 반면 야스오는 전사챔프들 중에서 먹이사슬 하위권인데다 에어본 의존도가 높아서 전사챔들 중에서도 사이드 운영보다 한타 운영을 선호하는 경우도 많기 때문이다. 물론 사이드 운영도 나름 가능한 하이머딩거 입장에서는 사이드조차 확정적으로 자신을 죽일 수 있는 이렐리아가 더 무섭지만 팀적으로는 이렐리아의 카운터가 있을 수 있는 한타 운영을 유도해도 되기 때문이다. 야스오의 경우에는 사이드는 이렐리아보다 상대하기 나을 뿐이지, 확실히 이긴다고 장담할 수 없고, 한타에서는 하이머딩거의 활약을 직접적으로 방해할 수 있기 때문에 문제인 것이다.
[32] 일라오이의 근원과도 같은 E스킬을 포탑으로 막을 수 있다. 포탑이 없다고 할지라도 그 주변에서 이속이 빨라지는 패시브의 존재로 인해서 E스킬을 맞히기 어렵다.
[33] 라인전 한정. 탱커치고는 유지력도 나쁘고 마법 피해에 취약하다. 다만 멈출 수 없는 힘(R)의 존재로 생존력이 부실한 하이머딩거를 위협하고 하이머딩거의 약점인 순간적인 한타를 유도를 할 수 있다는 점에서 하이머딩거에게도 거슬린다. 가능하면 라인전에서 크게 이득을 보는 게 중요하다.
[34] 대표적인 하드카운터로 알려져 있으나, 실상은 정반대. 스킬 분배를 정상적으로 하지 못하는 심해를 제외하면 대부분의 구간에서 통계상 우위를 점하는 상성이다. 결국 이렐리아는 파밍이나 딜교를 하려면 근접해야 하는데, 딩거 상대로 선진입을 하는 순간 수류탄에서 이어지는 폭딜로 삭제당한다. 돌진이 직선적이고 뻔하기 때문에 대응하기도 쉬운 것은 덤. q로 포탑을 타고 들어오는 것은 껄끄럽지만 초반에는 q 한 방에 포탑을 지울 수 없고 평타로 포탑을 치려다간 즉시 얻어맞게 된다. 다만 수류탄이 빗나가면 위험해지기 때문에 수류탄은 신중하게 쓸 것. 어차피 한 턴에 터지지 않는 이상 수류탄을 맞히면 확실하게 딜교를 이기니 급하게 쓸 필요 없다.
[35] 어느 라인에서 만나든, 심지어 직접 마주칠일이 가장 적은 구도라도 게임 내내 모르가나의 하드카운터이다. 모르가나 장판 매커니즘상 초반부터 후반까지 하이머딩거의 포탑을 지울수가 없으며 하이머딩거의 기절을 칠흑의 방패로 씹을수 있다는 유일한 장점은 속박을 포탑으로 막을수 있고, 코어템인 존야도 포탑을 미리 깔아두는 식으로 무력화시킬수 있다는 점들이 치명적이라 의미가 없다시피 하다. 그나마 미드나 정글 모르가나 vs 서폿 딩거의 구도는 모르가나가 렙차와 아이템 빨을 이용해서 점멸궁속박 콤보를 통해 어거지로 솔킬을 낼 수 있는 여지는 있지만 정글이나 미드 모르가나가 서폿 딩거 하나 잡기 위해서 점멸까지 써가며 잡아야 한다는 게 결코 이득이 아니며, 속박을 포탑으로 막을 수 있다는 큰 이점은 여전하기 때문에 골치 아픈건 매한 가지다. 거기다 딩거는 성능이 좋을 때도 하는 사람만 할정도로 픽률이 적어서 밴 카드를 쓰기도 아까운데 정작 숙련도가 조금만 있어도 모르가나를 게임내내 골치 아프게 할 수 있기 때문에 답이 없다.










"""
    # ⭐️⭐️⭐️⭐️⭐️
    
    print(f"--- 수동 파서 시작: {CHAMPION_NAME} ---")
    
    # 4. 파싱 실행
    new_champion_data = parse_manual_data(CHAMPION_NAME, RAW_COUNTERS_TEXT, RAW_FOOTNOTES_TEXT)

    # 5. 기존 데이터 로드
    all_data_list = load_and_prepare_data(TARGET_FILE)

    # 6. 데이터 업데이트 또는 추가
    updated = False
    for i, data in enumerate(all_data_list):
        if data.get('champion') == new_champion_data['champion']:
            all_data_list[i] = new_champion_data # 기존 데이터 덮어쓰기
            updated = True 
            print(f"'{new_champion_data['champion']}'의 데이터를 업데이트했습니다.")
            break
            
    if not updated:
        all_data_list.append(new_champion_data) # 새 데이터 추가
        print(f"'{new_champion_data['champion']}'의 데이터를 새로 추가했습니다.")

    # 7. 파일 저장
    save_data(TARGET_FILE, all_data_list)
    print(f"성공: 데이터가 '{TARGET_FILE}' 파일에 저장되었습니다.")
if __name__ == '__main__':
    main()